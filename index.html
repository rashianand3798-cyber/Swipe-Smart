<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swipe Smart - Intelligent Credit Card Recommendations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Card Selection - Black/Grey Theme */
        .card-checkbox {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-checkbox:checked + label {
            background-color: #18181b;
            border-color: #18181b;
            border-width: 2px;
        }
        
        .card-checkbox:checked + label .card-title {
            color: #ffffff;
        }
        
        .card-checkbox:checked + label .card-subtitle {
            color: #d1d5db;
        }
        
        .card-checkbox:checked + label::after {
            content: '✓';
            position: absolute;
            top: 16px;
            right: 16px;
            color: #ffffff;
            font-weight: bold;
            font-size: 20px;
        }
        
        /* Reward Radio - Black/Grey Theme */
        .reward-type-radio:checked + label {
            background-color: #18181b;
            border-color: #18181b;
            border-width: 2px;
        }
        
        .reward-type-radio:checked + label .reward-title {
            color: #ffffff;
        }
        
        .reward-type-radio:checked + label .reward-subtitle {
            color: #d1d5db;
        }
        
        .loading {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-indicator {
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            background-color: #18181b;
            color: white;
        }

        .step-indicator.completed {
            background-color: #52525b;
            color: white;
        }

        /* Autocomplete */
        .autocomplete-dropdown {
            max-height: 280px;
            overflow-y: auto;
            z-index: 1000;
        }

        .autocomplete-item {
            transition: background-color 0.15s ease;
        }

        .autocomplete-item:hover {
            background-color: #fafafa;
        }

        .autocomplete-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .autocomplete-dropdown::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .autocomplete-dropdown::-webkit-scrollbar-thumb {
            background: #d4d4d8;
            border-radius: 3px;
        }

        .autocomplete-dropdown::-webkit-scrollbar-thumb:hover {
            background: #a1a1aa;
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    
    <!-- Header -->
    <header class="border-b border-zinc-200">
        <div class="max-w-3xl mx-auto px-6 py-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-semibold text-zinc-900">Swipe Smart</h1>
                <p class="text-sm text-zinc-600 mt-0.5">Intelligent card recommendations</p>
            </div>
            <div id="profileBtn" class="hidden flex gap-4">
                <button onclick="showHistoryModal()" class="text-sm text-zinc-900 hover:text-zinc-700 font-medium transition underline">
                    History
                </button>
                <button onclick="editProfile()" class="text-sm text-zinc-900 hover:text-zinc-700 font-medium transition underline">
                    Edit Profile
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-6 py-12">

        <!-- Savings Tracker -->
        <div id="savingsTracker" class="hidden mb-8">
            <div class="bg-zinc-50 border border-zinc-200 rounded-xl p-8">
                <div class="flex items-baseline justify-between">
                    <div>
                        <p class="text-sm font-medium text-zinc-500 mb-2">Total Saved This Month</p>
                        <p class="text-5xl font-light text-zinc-900" id="totalSavings">₹0</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-zinc-600" id="savingsCount">0 recommendations</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ONBOARDING FLOW -->
        <div id="onboardingFlow" class="hidden">
            
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="fade-in">
                <div class="max-w-lg mx-auto text-center py-16">
                    <h2 class="text-5xl font-light text-zinc-900 mb-6">Welcome</h2>
                    <p class="text-lg text-zinc-700 mb-4">
                        Never wonder which credit card to use again.
                    </p>
                    <p class="text-zinc-600 mb-12">
                        Set up your profile to get instant, personalized recommendations for every purchase.
                    </p>
                    <button onclick="startOnboarding()" class="bg-zinc-900 hover:bg-zinc-800 text-white font-medium py-4 px-10 rounded-lg transition">
                        Get Started
                    </button>
                </div>
            </div>

            <!-- Step Indicators -->
            <div id="stepIndicators" class="hidden mb-12">
                <div class="flex justify-center items-center space-x-3">
                    <div class="step-indicator w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center text-sm font-medium text-zinc-600" data-step="1">1</div>
                    <div class="w-12 h-0.5 bg-zinc-200"></div>
                    <div class="step-indicator w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center text-sm font-medium text-zinc-600" data-step="2">2</div>
                    <div class="w-12 h-0.5 bg-zinc-200"></div>
                    <div class="step-indicator w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center text-sm font-medium text-zinc-600" data-step="3">3</div>
                    <div class="w-12 h-0.5 bg-zinc-200"></div>
                    <div class="step-indicator w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center text-sm font-medium text-zinc-600" data-step="4">4</div>
                    <div class="w-12 h-0.5 bg-zinc-200"></div>
                    <div class="step-indicator w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center text-sm font-medium text-zinc-600" data-step="5">5</div>
                </div>
            </div>

            <!-- Question 1: Cards Owned -->
            <div id="question1" class="hidden fade-in">
                <div class="bg-white rounded-xl border border-zinc-200 p-10">
                    <h2 class="text-3xl font-light text-zinc-900 mb-3">Which cards do you own?</h2>
                    <p class="text-zinc-600 mb-10">Select all that apply</p>
                    
                                        <div class="space-y-3 mb-12 max-h-96 overflow-y-auto pr-2">
                        <div class="relative">
                            <input type="checkbox" id="onboard-card1" value="SBI Cashback" class="hidden card-checkbox" />
                            <label for="onboard-card1" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">SBI Cashback</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">5% online, 1% offline</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card2" value="Amazon Pay ICICI" class="hidden card-checkbox" />
                            <label for="onboard-card2" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">Amazon Pay ICICI</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">5% on Amazon</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card3" value="Swiggy HDFC" class="hidden card-checkbox" />
                            <label for="onboard-card3" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">Swiggy HDFC</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">10% on Swiggy</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card4" value="HDFC Millennia" class="hidden card-checkbox" />
                            <label for="onboard-card4" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">HDFC Millennia</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">5% on partners</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card5" value="Axis Magnus" class="hidden card-checkbox" />
                            <label for="onboard-card5" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">Axis Magnus</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">Premium rewards</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card6" value="Flipkart Axis" class="hidden card-checkbox" />
                            <label for="onboard-card6" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">Flipkart Axis</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">5% on Flipkart/Myntra</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card7" value="Scapia" class="hidden card-checkbox" />
                            <label for="onboard-card7" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">Scapia</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">Travel rewards + milestones</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card8" value="Indian Oil HDFC" class="hidden card-checkbox" />
                            <label for="onboard-card8" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">Indian Oil HDFC</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">5% fuel surcharge waiver</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card9" value="BPCL Octane ICICI" class="hidden card-checkbox" />
                            <label for="onboard-card9" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">BPCL Octane ICICI</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">₹0.50/litre at BPCL</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card10" value="ICICI Coral" class="hidden card-checkbox" />
                            <label for="onboard-card10" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">ICICI Coral</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">2X on dining/entertainment</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card11" value="AU Lit" class="hidden card-checkbox" />
                            <label for="onboard-card11" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">AU Lit</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">2% on food/entertainment</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card12" value="Axis Ace" class="hidden card-checkbox" />
                            <label for="onboard-card12" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">Axis Ace</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">5% Google Pay/bills, 4% food</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card13" value="SBI SimplyCLICK" class="hidden card-checkbox" />
                            <label for="onboard-card13" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">SBI SimplyCLICK</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">10X on online shopping</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card14" value="HDFC Regalia Gold" class="hidden card-checkbox" />
                            <label for="onboard-card14" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">HDFC Regalia Gold</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">4X dining/international</span>
                            </label>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="onboard-card15" value="Amex Platinum Travel" class="hidden card-checkbox" />
                            <label for="onboard-card15" class="block p-4 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <span class="card-title font-semibold text-zinc-900">Amex Platinum Travel</span>
                                <span class="card-subtitle text-xs block text-zinc-500 mt-1">5X travel + milestones</span>
                            </label>
                        </div>
                    </div>

                    <p class="text-sm text-red-600 mb-4 hidden" id="q1Error">Please select at least one card</p>

                    <button onclick="nextQuestion(1)" class="w-full bg-zinc-900 hover:bg-zinc-800 text-white font-medium py-4 rounded-xl transition">
                        Continue
                    </button>
                </div>
            </div>

            <!-- Question 2: Preferred Card -->
            <div id="question2" class="hidden fade-in">
                <div class="bg-white rounded-xl border border-zinc-200 p-10">
                    <h2 class="text-3xl font-light text-zinc-900 mb-3">Default card preference</h2>
                    <p class="text-zinc-600 mb-10">Used to break ties when rewards are similar</p>
                    
                    <select id="preferredCard" class="w-full p-4 border-2 border-zinc-200 rounded-xl mb-12 focus:ring-2 focus:ring-zinc-900 focus:border-zinc-900 text-zinc-900 text-lg">
                        <option value="">Select your preferred card</option>
                    </select>

                    <div class="flex gap-4">
                        <button onclick="prevQuestion(2)" class="flex-1 border-2 border-zinc-200 hover:bg-zinc-50 text-zinc-700 font-medium py-4 rounded-xl transition">
                            Back
                        </button>
                        <button onclick="nextQuestion(2)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-medium py-4 rounded-xl transition">
                            Continue
                        </button>
                    </div>
                </div>
            </div>

            <!-- Question 3: Reward Preference -->
            <div id="question3" class="hidden fade-in">
                <div class="bg-white rounded-xl border border-zinc-200 p-10">
                    <h2 class="text-3xl font-light text-zinc-900 mb-3">Reward preference</h2>
                    <p class="text-zinc-600 mb-10">We'll prioritize this when values are similar</p>
                    
                    <div class="space-y-4 mb-12">
                        <div>
                            <input type="radio" name="rewardPreference" value="cashback" id="pref-cashback" class="hidden reward-type-radio" />
                            <label for="pref-cashback" class="flex items-center p-5 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <div class="flex-1">
                                    <span class="reward-title font-semibold text-zinc-900 block text-lg">Cashback</span>
                                    <span class="reward-subtitle text-sm text-zinc-500">Direct money back</span>
                                </div>
                            </label>
                        </div>
                        
                        <div>
                            <input type="radio" name="rewardPreference" value="miles" id="pref-miles" class="hidden reward-type-radio" />
                            <label for="pref-miles" class="flex items-center p-5 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <div class="flex-1">
                                    <span class="reward-title font-semibold text-zinc-900 block text-lg">Air Miles</span>
                                    <span class="reward-subtitle text-sm text-zinc-500">Travel rewards</span>
                                </div>
                            </label>
                        </div>
                        
                        <div>
                            <input type="radio" name="rewardPreference" value="points" id="pref-points" class="hidden reward-type-radio" />
                            <label for="pref-points" class="flex items-center p-5 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <div class="flex-1">
                                    <span class="reward-title font-semibold text-zinc-900 block text-lg">Reward Points</span>
                                    <span class="reward-subtitle text-sm text-zinc-500">Flexible redemption</span>
                                </div>
                            </label>
                        </div>
                        
                        <div>
                            <input type="radio" name="rewardPreference" value="fuel" id="pref-fuel" class="hidden reward-type-radio" />
                            <label for="pref-fuel" class="flex items-center p-5 border-2 border-zinc-200 rounded-xl cursor-pointer hover:border-zinc-300 transition">
                                <div class="flex-1">
                                    <span class="reward-title font-semibold text-zinc-900 block text-lg">Fuel Rewards</span>
                                    <span class="reward-subtitle text-sm text-zinc-500">Petrol/diesel savings</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="prevQuestion(3)" class="flex-1 border-2 border-zinc-200 hover:bg-zinc-50 text-zinc-700 font-medium py-4 rounded-xl transition">
                            Back
                        </button>
                        <button onclick="nextQuestion(3)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-medium py-4 rounded-xl transition">
                            Continue
                        </button>
                    </div>
                </div>
            </div>

            <!-- Question 4: Monthly Spending -->
            <div id="question4" class="hidden fade-in">
                <div class="bg-white rounded-xl border border-zinc-200 p-10">
                    <h2 class="text-3xl font-light text-zinc-900 mb-3">Monthly spending</h2>
                    <p class="text-zinc-600 mb-10">Approximate credit card usage per month</p>
                    
                    <div class="space-y-3 mb-12">
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="radio" name="monthlySpend" value="<10k" class="mr-3 text-zinc-900 focus:ring-zinc-900" />
                            <span class="text-zinc-900">Less than ₹10,000</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="radio" name="monthlySpend" value="10k-25k" class="mr-3 text-zinc-900 focus:ring-zinc-900" />
                            <span class="text-zinc-900">₹10,000 - ₹25,000</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="radio" name="monthlySpend" value="25k-50k" class="mr-3 text-zinc-900 focus:ring-zinc-900" />
                            <span class="text-zinc-900">₹25,000 - ₹50,000</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="radio" name="monthlySpend" value="50k-1L" class="mr-3 text-zinc-900 focus:ring-zinc-900" />
                            <span class="text-zinc-900">₹50,000 - ₹1,00,000</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="radio" name="monthlySpend" value=">1L" class="mr-3 text-zinc-900 focus:ring-zinc-900" />
                            <span class="text-zinc-900">More than ₹1,00,000</span>
                        </label>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="prevQuestion(4)" class="flex-1 border-2 border-zinc-200 hover:bg-zinc-50 text-zinc-700 font-medium py-4 rounded-xl transition">
                            Back
                        </button>
                        <button onclick="nextQuestion(4)" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-medium py-4 rounded-xl transition">
                            Continue
                        </button>
                    </div>
                </div>
            </div>

            <!-- Question 5: Common Categories -->
            <div id="question5" class="hidden fade-in">
                <div class="bg-white rounded-xl border border-zinc-200 p-10">
                    <h2 class="text-3xl font-light text-zinc-900 mb-3">Primary spending categories</h2>
                    <p class="text-zinc-600 mb-10">Select your top 2-3 categories (optional)</p>
                    
                    <div class="grid grid-cols-2 gap-3 mb-12">
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="checkbox" value="Food Delivery" class="mr-3 text-zinc-900 focus:ring-zinc-900" name="categories" />
                            <span class="text-zinc-900">Food Delivery</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="checkbox" value="Online Shopping" class="mr-3 text-zinc-900 focus:ring-zinc-900" name="categories" />
                            <span class="text-zinc-900">Online Shopping</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="checkbox" value="Groceries" class="mr-3 text-zinc-900 focus:ring-zinc-900" name="categories" />
                            <span class="text-zinc-900">Groceries</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="checkbox" value="Travel" class="mr-3 text-zinc-900 focus:ring-zinc-900" name="categories" />
                            <span class="text-zinc-900">Travel</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="checkbox" value="Dining" class="mr-3 text-zinc-900 focus:ring-zinc-900" name="categories" />
                            <span class="text-zinc-900">Dining</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="checkbox" value="Entertainment" class="mr-3 text-zinc-900 focus:ring-zinc-900" name="categories" />
                            <span class="text-zinc-900">Entertainment</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="checkbox" value="Fuel" class="mr-3 text-zinc-900 focus:ring-zinc-900" name="categories" />
                            <span class="text-zinc-900">Fuel</span>
                        </label>
                        <label class="flex items-center p-4 hover:bg-zinc-50 rounded-xl cursor-pointer transition">
                            <input type="checkbox" value="Bills & Utilities" class="mr-3 text-zinc-900 focus:ring-zinc-900" name="categories" />
                            <span class="text-zinc-900">Bills & Utilities</span>
                        </label>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="prevQuestion(5)" class="flex-1 border-2 border-zinc-200 hover:bg-zinc-50 text-zinc-700 font-medium py-4 rounded-xl transition">
                            Back
                        </button>
                        <button onclick="completeOnboarding()" class="flex-1 bg-zinc-900 hover:bg-zinc-800 text-white font-medium py-4 rounded-xl transition">
                            Complete Setup
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- MAIN APP -->
        <div id="mainApp" class="hidden">
            
            <!-- User Profile Summary -->
            <div id="profileSummary" class="mb-8 bg-zinc-50 border border-zinc-200 rounded-xl p-8">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-zinc-500 mb-4">Your Cards</p>
                        <div id="userCardsList" class="flex flex-wrap gap-2 mb-4">
                            <!-- Cards will be inserted here -->
                        </div>
                        <p class="text-sm text-zinc-700">
                            Prefers: <span id="userRewardPref" class="font-semibold text-zinc-900">-</span>
                        </p>
                    </div>
                    <button onclick="editProfile()" class="text-sm text-zinc-900 hover:text-zinc-700 font-medium transition underline">
                        Edit
                    </button>
                </div>
            </div>

            <!-- Quick Recommendation Form -->
            <div class="bg-white border border-zinc-200 rounded-xl p-10">
                <h2 class="text-2xl font-light text-zinc-900 mb-8">Get Recommendation</h2>
                
                <form id="quickRecommendationForm" class="space-y-6">
                    
                    <!-- Merchant Input with Autocomplete -->
                    <div class="relative">
                        <label for="quickMerchant" class="block text-sm font-semibold text-zinc-700 mb-2">
                            Merchant
                        </label>
                        <input 
                            type="text" 
                            id="quickMerchant" 
                            required
                            autocomplete="off"
                            placeholder="Select from list or type custom"
                            class="w-full px-4 py-4 border-2 border-zinc-200 rounded-xl focus:ring-2 focus:ring-zinc-900 focus:border-zinc-900 text-zinc-900 text-lg"
                        />
                        <div id="merchantDropdown" class="hidden absolute w-full bg-white border-2 border-zinc-200 rounded-xl shadow-lg mt-2 autocomplete-dropdown">
                        </div>
                    </div>

                    <!-- Custom Merchant Input -->
                    <div id="customMerchantInput" class="hidden">
                        <label for="customMerchant" class="block text-sm font-semibold text-zinc-700 mb-2">
                            Custom Merchant Name
                        </label>
                        <input 
                            type="text" 
                            id="customMerchant" 
                            placeholder="e.g., Local Grocery Store"
                            class="w-full px-4 py-4 border-2 border-zinc-200 rounded-xl focus:ring-2 focus:ring-zinc-900 focus:border-zinc-900 text-zinc-900 text-lg"
                        />
                    </div>

                    <!-- Amount Input -->
                    <div>
                        <label for="quickAmount" class="block text-sm font-semibold text-zinc-700 mb-2">
                            Amount
                        </label>
                        <input 
                            type="number" 
                            id="quickAmount" 
                            required
                            min="1"
                            placeholder="1000"
                            class="w-full px-4 py-4 border-2 border-zinc-200 rounded-xl focus:ring-2 focus:ring-zinc-900 focus:border-zinc-900 text-zinc-900 text-lg"
                        />
                    </div>

                    <!-- Category Dropdown -->
                    <div>
                        <label for="quickCategory" class="block text-sm font-semibold text-zinc-700 mb-2">
                            Category
                        </label>
                        <select 
                            id="quickCategory"
                            class="w-full px-4 py-4 border-2 border-zinc-200 rounded-xl focus:ring-2 focus:ring-zinc-900 focus:border-zinc-900 text-zinc-900 text-lg"
                        >
                            <option value="">Auto-detect</option>
                            <option value="food delivery">Food Delivery</option>
                            <option value="online shopping">Online Shopping</option>
                            <option value="groceries">Groceries</option>
                            <option value="travel">Travel</option>
                            <option value="dining">Dining</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="fuel">Fuel</option>
                            <option value="offline">Offline/Local Store</option>
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <button 
                        type="submit" 
                        class="w-full bg-zinc-900 hover:bg-zinc-800 text-white font-medium py-4 rounded-xl transition text-lg"
                    >
                        Get Recommendation
                    </button>
                </form>
            </div>

        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden py-16 text-center">
            <div class="inline-flex items-center">
                <div class="loading w-6 h-6 border-2 border-zinc-900 border-t-transparent rounded-full"></div>
                <span class="ml-3 text-zinc-700 font-medium">Analyzing...</span>
            </div>
        </div>

        <!-- Results Card -->
        <div id="resultsCard" class="hidden fade-in">
            <div class="bg-white border border-zinc-200 rounded-xl p-10 mb-6">
                <div class="mb-8">
                    <p class="text-sm font-medium text-zinc-500 mb-3">Recommended Card</p>
                    <h3 class="text-4xl font-light text-zinc-900 mb-2" id="bestCard">-</h3>
                    <p class="text-2xl text-zinc-700 font-medium" id="bestReward">-</p>
                </div>
                
                <div class="border-t border-zinc-200 pt-8 mb-8">
                    <p class="text-zinc-700 text-lg leading-relaxed" id="explanation">-</p>
                </div>

                <!-- Savings Breakdown -->
                <div id="breakdownSection" class="hidden border-t border-zinc-200 pt-8 mb-8">
                    <div id="breakdownContent">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>

                <!-- Confidence indicator -->
                <div class="mb-8">
                    <div class="flex items-center justify-between text-sm mb-3">
                        <span class="text-zinc-600 font-medium">Confidence</span>
                        <span class="text-zinc-900 font-semibold text-lg" id="confidenceText">-</span>
                    </div>
                    <div class="w-full bg-zinc-200 rounded-full h-2">
                        <div id="confidenceBar" class="bg-zinc-900 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Alternative Cards -->
                <div id="alternativesSection" class="hidden border-t border-zinc-200 pt-8">
                    <p class="text-sm font-medium text-zinc-500 mb-4">Other Options</p>
                    <div id="alternativesList" class="space-y-3">
                        <!-- Alternatives will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <button 
                onclick="resetForm()" 
                class="w-full border-2 border-zinc-200 hover:bg-zinc-50 text-zinc-700 font-medium py-4 rounded-xl transition"
            >
                New Recommendation
            </button>
        </div>

        <!-- Error Message -->
        <div id="errorCard" class="hidden border-2 border-red-200 bg-red-50 rounded-xl p-8">
            <p class="text-base font-semibold text-red-900 mb-2">Error</p>
            <p class="text-red-700 mb-6" id="errorMessage">-</p>
            <button 
                onclick="resetForm()" 
                class="text-red-700 hover:text-red-800 font-semibold underline"
            >
                Try Again
            </button>
        </div>


        <!-- History Modal -->
        <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                <div class="p-6 border-b border-zinc-200 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-semibold text-zinc-900">Recommendation History</h2>
                        <p class="text-sm text-zinc-600 mt-1">Your past card recommendations</p>
                    </div>
                    <button onclick="closeHistoryModal()" class="text-zinc-500 hover:text-zinc-700 text-2xl">&times;</button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="historyList">
                        <!-- History items will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="border-t border-zinc-200 mt-24 py-12 text-center text-sm text-zinc-600">
        <p class="font-medium text-zinc-900">Swipe Smart</p>
        <p class="mt-2">
            <a href="#" onclick="resetProfile(); return false;" class="text-zinc-900 hover:text-zinc-700 font-medium underline">Reset Profile</a>
        </p>
    </footer>

    <script>
        // ⚙️ CONFIGURATION
        const WEBHOOK_URL = 'https://steep-snow-ab31swipe-smart-proxy.rashi-anand3798.workers.dev';

        // POPULAR MERCHANTS DATABASE
        const POPULAR_MERCHANTS = [
            { name: 'Swiggy', category: 'food delivery' },
            { name: 'Zomato', category: 'food delivery' },
            { name: 'Swiggy Instamart', category: 'food delivery' },
            { name: 'Zepto', category: 'food delivery' },
            { name: 'Blinkit', category: 'food delivery' },
            { name: 'Dunzo', category: 'food delivery' },
            { name: 'Amazon', category: 'online shopping' },
            { name: 'Flipkart', category: 'online shopping' },
            { name: 'Myntra', category: 'online shopping' },
            { name: 'Ajio', category: 'online shopping' },
            { name: 'Nykaa', category: 'online shopping' },
            { name: 'Tata CLiQ', category: 'online shopping' },
            { name: 'Meesho', category: 'online shopping' },
            { name: 'BookMyShow', category: 'entertainment' },
            { name: 'Netflix', category: 'entertainment' },
            { name: 'Amazon Prime Video', category: 'entertainment' },
            { name: 'Disney+ Hotstar', category: 'entertainment' },
            { name: 'Sony LIV', category: 'entertainment' },
            { name: 'Uber', category: 'travel' },
            { name: 'Ola', category: 'travel' },
            { name: 'MakeMyTrip', category: 'travel' },
            { name: 'Goibibo', category: 'travel' },
            { name: 'Cleartrip', category: 'travel' },
            { name: 'Rapido', category: 'travel' },
            { name: 'Dineout', category: 'dining' },
            { name: 'Cult.fit', category: 'fitness' },
            { name: 'Other (Custom)', category: 'offline', isCustom: true }
        ];

        const REWARD_LABELS = {
            'cashback': 'Cashback',
            'miles': 'Air Miles',
            'points': 'Reward Points',
            'fuel': 'Fuel Rewards'
        };

        let userProfile = null;
        let savingsData = null;
        let currentStep = 0;

        // Autocomplete functionality
        const merchantInput = document.getElementById('quickMerchant');
        const merchantDropdown = document.getElementById('merchantDropdown');
        const customMerchantInput = document.getElementById('customMerchantInput');

        if (merchantInput) {
            merchantInput.addEventListener('focus', function() {
                showMerchantDropdown('');
            });

            merchantInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                showMerchantDropdown(query);
            });
            
            document.addEventListener('click', function(e) {
                if (e.target !== merchantInput && !merchantDropdown.contains(e.target)) {
                    merchantDropdown.classList.add('hidden');
                }
            });
        }

        function showMerchantDropdown(query) {
            let filtered = POPULAR_MERCHANTS;
            
            if (query.length > 0) {
                filtered = POPULAR_MERCHANTS.filter(m => 
                    m.name.toLowerCase().includes(query)
                );
            }
            
            if (filtered.length > 0) {
                merchantDropdown.innerHTML = filtered.map(m => {
                    const displayText = m.isCustom ? 
                        '<span class="text-sm font-semibold text-zinc-900">Other (Custom Merchant)</span><span class="text-xs text-zinc-600 ml-2">Type your own</span>' :
                        `<span class="text-sm font-semibold text-zinc-900">${m.name}</span><span class="text-xs text-zinc-500 ml-2">${m.category}</span>`;
                    
                    return `<div class="autocomplete-item p-4 cursor-pointer border-b border-zinc-100 last:border-0" onclick='selectMerchant(${JSON.stringify(m.name)}, ${JSON.stringify(m.category)}, ${m.isCustom || false})'>${displayText}</div>`;
                }).join('');
                merchantDropdown.classList.remove('hidden');
            } else {
                merchantDropdown.classList.add('hidden');
            }
        }

        function selectMerchant(name, category, isCustom) {
            if (isCustom) {
                merchantInput.value = '';
                merchantInput.placeholder = 'Type custom merchant name...';
                customMerchantInput.classList.remove('hidden');
                document.getElementById('quickCategory').value = category;
            } else {
                merchantInput.value = name;
                customMerchantInput.classList.add('hidden');
                document.getElementById('quickCategory').value = category;
            }
            merchantDropdown.classList.add('hidden');
        }

        function initApp() {
            userProfile = loadProfile();
            savingsData = loadSavings();
            
            if (userProfile) {
                showMainApp();
                updateSavingsTracker();
            } else {
                showOnboarding();
            }
        }

        function loadSavings() {
            const stored = localStorage.getItem('swipesmart_savings');
            if (stored) {
                return JSON.parse(stored);
            }
            return {
                monthlyTotal: 0,
                count: 0,
                currentMonth: new Date().getMonth()
            };
        }

        function saveSavings(data) {
            localStorage.setItem('swipesmart_savings', JSON.stringify(data));
            savingsData = data;
        }

        function loadHistory() {
            const stored = localStorage.getItem('swipesmart_history');
            return stored ? JSON.parse(stored) : [];
        }

        function saveHistory(recommendation) {
            const history = loadHistory();
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                merchant: recommendation.merchant,
                amount: recommendation.amount,
                bestCard: recommendation.bestCard,
                totalSaved: recommendation.bestReward,
                breakdown: recommendation.breakdown || {
                    base: recommendation.bestReward,
                    accelerated: 0,
                    milestone: 0
                },
                breakdownDetails: recommendation.breakdownDetails || {},
                explanation: recommendation.explanation
            };
            history.unshift(entry); // Add to beginning
            if (history.length > 50) history.pop(); // Keep last 50
            localStorage.setItem('swipesmart_history', JSON.stringify(history));
        }

        function displayHistory() {
            const history = loadHistory();
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-zinc-500 text-center py-8">No recommendations yet</p>';
                return;
            }

            historyList.innerHTML = history.map(entry => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                
                return `
                    <div class="border border-zinc-200 rounded-xl overflow-hidden mb-3 history-item">
                        <div class="p-4 cursor-pointer hover:bg-zinc-50 transition" onclick="toggleHistoryDetail('${entry.id}')">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-zinc-900">${entry.merchant}</p>
                                    <p class="text-xs text-zinc-500 mt-0.5">${dateStr} • ₹${entry.amount} → ${entry.bestCard}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-semibold text-green-700">Save ₹${entry.totalSaved.toFixed(2)}</p>
                                    <p class="text-xs text-zinc-500">Tap for details</p>
                                </div>
                            </div>
                        </div>
                        <div id="detail-${entry.id}" class="hidden bg-zinc-50 p-4 border-t border-zinc-200">
                            <p class="text-xs font-semibold text-zinc-700 mb-3">Savings Breakdown</p>
                            ${entry.breakdown.base > 0 ? `
                            <div class="flex justify-between items-center mb-2 text-xs">
                                <span class="text-zinc-600">Base Reward:</span>
                                <span class="font-semibold text-zinc-900">₹${entry.breakdown.base.toFixed(2)}</span>
                            </div>
                            ${entry.breakdownDetails?.base?.reason ? `<p class="text-xs text-zinc-500 mb-2">${entry.breakdownDetails.base.reason}</p>` : ''}
                            ` : ''}
                            ${entry.breakdown.accelerated > 0 ? `
                            <div class="flex justify-between items-center mb-2 text-xs">
                                <span class="text-zinc-600">Accelerated Reward:</span>
                                <span class="font-semibold text-green-700">₹${entry.breakdown.accelerated.toFixed(2)}</span>
                            </div>
                            ${entry.breakdownDetails?.accelerated?.reason ? `<p class="text-xs text-zinc-500 mb-2">${entry.breakdownDetails.accelerated.reason}</p>` : ''}
                            ` : ''}
                            ${entry.breakdown.milestone > 0 ? `
                            <div class="flex justify-between items-center mb-2 text-xs">
                                <span class="text-zinc-600">Milestone Bonus:</span>
                                <span class="font-semibold text-amber-600">₹${entry.breakdown.milestone.toFixed(2)}</span>
                            </div>
                            ${entry.breakdownDetails?.milestone?.reason ? `<p class="text-xs text-zinc-500 mb-2">${entry.breakdownDetails.milestone.reason}</p>` : ''}
                            ` : ''}
                            <div class="border-t border-zinc-200 mt-3 pt-3 flex justify-between items-center text-sm">
                                <span class="font-semibold text-zinc-700">Total Savings:</span>
                                <span class="font-bold text-zinc-900">₹${entry.totalSaved.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleHistoryDetail(id) {
            const detail = document.getElementById(`detail-${id}`);
            if (detail.classList.contains('hidden')) {
                detail.classList.remove('hidden');
                detail.classList.add('fade-in');
            } else {
                detail.classList.add('hidden');
            }
        }

        function showHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            displayHistory();
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }


        function updateSavingsTracker() {
            const currentMonth = new Date().getMonth();
            
            if (savingsData.currentMonth !== currentMonth) {
                savingsData.monthlyTotal = 0;
                savingsData.count = 0;
                savingsData.currentMonth = currentMonth;
                saveSavings(savingsData);
            }
            
            document.getElementById('totalSavings').textContent = `₹${savingsData.monthlyTotal.toFixed(0)}`;
            document.getElementById('savingsCount').textContent = `${savingsData.count} recommendation${savingsData.count !== 1 ? 's' : ''}`;
            document.getElementById('savingsTracker').classList.remove('hidden');
        }

        function showOnboarding() {
            document.getElementById('onboardingFlow').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('profileBtn').classList.add('hidden');
            document.getElementById('savingsTracker').classList.add('hidden');
        }

        function startOnboarding() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('stepIndicators').classList.remove('hidden');
            showQuestion(1);
        }

        function showQuestion(questionNum) {
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`question${i}`).classList.add('hidden');
            }
            document.getElementById(`question${questionNum}`).classList.remove('hidden');
            updateStepIndicators(questionNum);
            currentStep = questionNum;
        }

        function updateStepIndicators(activeStep) {
            for (let i = 1; i <= 5; i++) {
                const indicator = document.querySelector(`[data-step="${i}"]`);
                indicator.classList.remove('active', 'completed');
                
                if (i === activeStep) {
                    indicator.classList.add('active');
                } else if (i < activeStep) {
                    indicator.classList.add('completed');
                }
            }
        }

        function nextQuestion(currentQ) {
            if (currentQ === 1) {
                const selectedCards = getSelectedOnboardingCards();
                if (selectedCards.length === 0) {
                    document.getElementById('q1Error').classList.remove('hidden');
                    return;
                }
                document.getElementById('q1Error').classList.add('hidden');
                populatePreferredCardDropdown(selectedCards);
            }
            
            if (currentQ === 2 && !document.getElementById('preferredCard').value) {
                alert('Please select your preferred card');
                return;
            }
            
            if (currentQ === 3 && !document.querySelector('input[name="rewardPreference"]:checked')) {
                alert('Please select your reward preference');
                return;
            }
            
            if (currentQ === 4 && !document.querySelector('input[name="monthlySpend"]:checked')) {
                alert('Please select your monthly spending range');
                return;
            }
            
            showQuestion(currentQ + 1);
        }

        function prevQuestion(currentQ) {
            showQuestion(currentQ - 1);
        }

        function getSelectedOnboardingCards() {
            const checkboxes = document.querySelectorAll('#question1 input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function populatePreferredCardDropdown(cards) {
            const select = document.getElementById('preferredCard');
            select.innerHTML = '<option value="">Select your preferred card</option>';
            cards.forEach(card => {
                const option = document.createElement('option');
                option.value = card;
                option.textContent = card;
                select.appendChild(option);
            });
        }

        function completeOnboarding() {
            const profile = {
                cardsOwned: getSelectedOnboardingCards(),
                preferredCard: document.getElementById('preferredCard').value,
                rewardPreference: document.querySelector('input[name="rewardPreference"]:checked')?.value || 'cashback',
                monthlySpend: document.querySelector('input[name="monthlySpend"]:checked')?.value || '',
                commonCategories: Array.from(document.querySelectorAll('input[name="categories"]:checked')).map(cb => cb.value),
                createdAt: new Date().toISOString()
            };
            
            if (profile.cardsOwned.length === 0) {
                alert('Please select at least one card');
                return;
            }
            
            saveProfile(profile);
            showMainApp();
        }

        function saveProfile(profile) {
            localStorage.setItem('swipesmart_profile', JSON.stringify(profile));
            userProfile = profile;
        }

        function loadProfile() {
            const stored = localStorage.getItem('swipesmart_profile');
            return stored ? JSON.parse(stored) : null;
        }

        function showMainApp() {
            document.getElementById('onboardingFlow').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('profileBtn').classList.remove('hidden');
            displayProfileSummary();
            updateSavingsTracker();
        }

        function displayProfileSummary() {
            const cardsList = document.getElementById('userCardsList');
            cardsList.innerHTML = '';
            
            userProfile.cardsOwned.forEach(card => {
                const badge = document.createElement('span');
                badge.className = 'text-sm px-4 py-2 bg-zinc-100 text-zinc-700 rounded-lg font-medium';
                badge.textContent = card;
                if (card === userProfile.preferredCard) {
                    badge.className = 'text-sm px-4 py-2 bg-zinc-900 text-white rounded-lg font-semibold';
                }
                cardsList.appendChild(badge);
            });
            
            document.getElementById('userRewardPref').textContent = REWARD_LABELS[userProfile.rewardPreference];
        }

        function editProfile() {
            document.querySelectorAll('#question1 input[type="checkbox"]').forEach(cb => cb.checked = false);
            userProfile.cardsOwned.forEach(card => {
                const checkbox = Array.from(document.querySelectorAll('#question1 input[type="checkbox"]'))
                    .find(cb => cb.value === card);
                if (checkbox) checkbox.checked = true;
            });
            
            const rewardRadio = document.querySelector(`input[name="rewardPreference"][value="${userProfile.rewardPreference}"]`);
            if (rewardRadio) rewardRadio.checked = true;
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('savingsTracker').classList.add('hidden');
            document.getElementById('onboardingFlow').classList.remove('hidden');
            document.getElementById('stepIndicators').classList.remove('hidden');
            showQuestion(1);
        }

        function resetProfile() {
            if (confirm('Reset your profile and all data?')) {
                localStorage.removeItem('swipesmart_profile');
                localStorage.removeItem('swipesmart_savings');
                location.reload();
            }
        }

        document.getElementById('quickRecommendationForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check if webhook is configured
            if (WEBHOOK_URL === 'YOUR_N8N_WEBHOOK_URL_HERE') {
                showError('Webhook URL not configured. Please update the WEBHOOK_URL in the HTML file with your n8n webhook URL.');
                return;
            }
            
            let merchant = merchantInput.value.trim();
            const customMerchant = document.getElementById('customMerchant').value.trim();
            
            if (customMerchant) {
                merchant = customMerchant;
            }
            
            const amount = parseFloat(document.getElementById('quickAmount').value);
            const category = document.getElementById('quickCategory').value;
            
            const payload = {
                merchant: merchant.toLowerCase(),
                amount: amount,
                category: category || null,
                cardsOwned: userProfile.cardsOwned,
                userPreferences: {
                    preferredCard: userProfile.preferredCard,
                    rewardType: userProfile.rewardPreference
                }
            };
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultsCard').classList.add('hidden');
            document.getElementById('errorCard').classList.add('hidden');
            
            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayResults(result);
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Unable to connect to recommendation service. ${error.message || 'Please check your n8n workflow is active and the webhook URL is correct.'}`);
            }
        });

        function displayResults(result) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultsCard').classList.remove('hidden');

            console.log('RAW n8n result:', JSON.stringify(result));

            // Handle different response wrapper formats from n8n
            if (Array.isArray(result)) result = result[0];
            if (result && result.json) result = result.json;
            if (result && result.body) result = result.body;

            console.log('Parsed result:', JSON.stringify(result));

            const bestCard = result.bestCard || result.best_card || 'Check n8n output';
            const bestReward = parseFloat(result.bestReward || result.best_reward || result.reward || 0);
            const explanation = result.explanation || result.bestReason || result.reason || '';
            const confidence = parseFloat(result.confidence || 0.9);
            const breakdown = result.breakdown || { base: bestReward, accelerated: 0, milestone: 0 };
            const breakdownDetails = result.breakdownDetails || {};

            document.getElementById('bestCard').textContent = bestCard;
            document.getElementById('bestReward').textContent = 'Save ₹' + bestReward.toFixed(2);
            document.getElementById('explanation').textContent = explanation;

            const confidencePercent = Math.round(confidence * 100);
            document.getElementById('confidenceBar').style.width = confidencePercent + '%';
            document.getElementById('confidenceText').textContent = confidencePercent + '%';

            // Display 3-tier breakdown
            const breakdownSection = document.getElementById('breakdownSection');
            if (breakdown && (breakdown.base > 0 || breakdown.accelerated > 0 || breakdown.milestone > 0)) {
                breakdownSection.classList.remove('hidden');
                let breakdownHTML = '<p class="text-sm font-medium text-zinc-500 mb-3">Savings Breakdown</p>';
                
                if (breakdown.base > 0) {
                    breakdownHTML += '<div class="flex justify-between items-center mb-2"><span class="text-sm text-zinc-700">Base Reward</span><span class="text-sm font-semibold text-zinc-900">₹' + breakdown.base.toFixed(2) + '</span></div>';
                    if (breakdownDetails.base && breakdownDetails.base.reason) {
                        breakdownHTML += '<p class="text-xs text-zinc-500 mb-3">' + breakdownDetails.base.reason + '</p>';
                    }
                }
                
                if (breakdown.accelerated > 0) {
                    breakdownHTML += '<div class="flex justify-between items-center mb-2"><span class="text-sm text-zinc-700">Accelerated Reward</span><span class="text-sm font-semibold text-green-700">₹' + breakdown.accelerated.toFixed(2) + '</span></div>';
                    if (breakdownDetails.accelerated && breakdownDetails.accelerated.reason) {
                        breakdownHTML += '<p class="text-xs text-zinc-500 mb-3">' + breakdownDetails.accelerated.reason + '</p>';
                    }
                }
                
                if (breakdown.milestone > 0) {
                    breakdownHTML += '<div class="flex justify-between items-center mb-2"><span class="text-sm text-zinc-700">Milestone Bonus</span><span class="text-sm font-semibold text-amber-600">₹' + breakdown.milestone.toFixed(2) + '</span></div>';
                    if (breakdownDetails.milestone && breakdownDetails.milestone.reason) {
                        breakdownHTML += '<p class="text-xs text-zinc-500 mb-3">' + breakdownDetails.milestone.reason + '</p>';
                    }
                }
                
                document.getElementById('breakdownContent').innerHTML = breakdownHTML;
            } else {
                breakdownSection.classList.add('hidden');
            }

            // Save to history
            saveHistory(result);

            // Update savings tracker
            savingsData.monthlyTotal += bestReward;
            savingsData.count += 1;
            saveSavings(savingsData);
            updateSavingsTracker();

            // Display alternatives
            const alternatives = result.alternatives;
            if (alternatives && Array.isArray(alternatives) && alternatives.length > 0) {
                document.getElementById('alternativesSection').classList.remove('hidden');
                const alternativesList = document.getElementById('alternativesList');
                alternativesList.innerHTML = '';
                alternatives.forEach(alt => {
                    const altDiv = document.createElement('div');
                    altDiv.className = 'flex justify-between items-start p-5 bg-zinc-50 border border-zinc-200 rounded-xl';
                    const rewardVal = parseFloat(alt.rewardValue || alt.reward || 0);
                    altDiv.innerHTML = '<div><p class="text-sm font-semibold text-zinc-900">' + (alt.card || '') + '</p><p class="text-xs text-zinc-600 mt-1">' + (alt.reason || alt.why || '') + '</p></div><span class="text-sm font-semibold text-zinc-900">₹' + rewardVal.toFixed(2) + '</span>';
                    alternativesList.appendChild(altDiv);
                });
            } else {
                document.getElementById('alternativesSection').classList.add('hidden');
            }
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('errorCard').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function resetForm() {
            document.getElementById('resultsCard').classList.add('hidden');
            document.getElementById('errorCard').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('quickRecommendationForm').reset();
            customMerchantInput.classList.add('hidden');
            merchantInput.placeholder = 'Select from list or type custom';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>
